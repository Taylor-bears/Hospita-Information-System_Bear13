## 需求复述
- 为患者提供预约管理：能查看医院可预约的医生并在线预约。
- 打通前后端：设计并实现接口与前端页面，确保数据准确流转。
- 复用药房系统的通用模式与组件（CRUD、路由分层、Ant Design 交互、Axios 封装）。

## 当前架构与约束
- 后端：FastAPI + SQLAlchemy + MySQL；已有用户与角色（admin/doctor/user），医生有审核状态（pending/active）。
- 前端：文档规划为 React + Ant Design + Vite，但仓库未包含前端目录，需要新增前端模块。
- 预约/排班：暂无模型与接口，需从零实现。

## 数据模型设计
- 新增排班与预约模型（`medical-system/backend/models.py` + `init_db.sql`）：
  - DoctorSchedule：`id`, `doctor_id`, `date`, `start_time`, `end_time`, `capacity`, `booked_count`, `status`(open/closed), `created_at`。
  - Appointment：`id`, `patient_id`(User.id, role=user), `doctor_id`, `schedule_id`, `status`(pending/confirmed/cancelled), `created_at`。
- 约束：
  - 仅`active`医生可见与可预约；患者必须`active`。
  - 同一患者同一时间段不能重复预约（唯一性约束）。
  - 预约扣减`capacity`或递增`booked_count`，超过容量禁止预约。

## 后端接口设计（新建模块 `medical-system/appointments/backend/routes.py`）
- 公共/患者端：
  - `GET /appointments/doctors`：列出可预约医生（active），附带可用排班统计。
  - `GET /appointments/doctor/{doctor_id}/schedules?date=YYYY-MM-DD`：获取该医生指定日期/范围内可用排班。
  - `POST /appointments`：创建预约（入参：`doctor_id`, `schedule_id`；用户从令牌解析），并做容量/重复校验。
  - `GET /appointments/my`：当前患者的预约列表与状态。
  - `POST /appointments/{id}/cancel`：患者主动取消（容量回滚或标记状态）。
- 医生端：
  - `GET /doctor/schedules/my`：医生查看自己的排班。
  - `POST /doctor/schedules`：医生发布排班（批量/单条）。
  - `DELETE /doctor/schedules/{id}`：删除未来排班（若有预约需限制或强制取消策略）。
  - `GET /doctor/appointments/my`：医生查看自己的预约列表。
- 管理端（可选）：
  - `GET /admin/appointments`：全局预约审计。
  - `POST /admin/appointments/{id}/cancel`：违规预约或异常处理。
- 权限：沿用现有角色（`user`=患者、`doctor`=医生、`admin`=管理员）；路由分组与依赖注入校验角色。

## 事务与并发控制
- 预约创建使用数据库事务：`with session.begin()`；读取排班行后检查`capacity/booked_count`并原子更新。
- 防止超卖：对排班行加悲观锁（MySQL InnoDB 可用 `SELECT ... FOR UPDATE`/SQLAlchemy 等效）。
- 保证幂等：相同患者对同一`schedule_id`重复提交返回已存在，不重复扣减。

## 前端页面与交互（新建 `medical-system/frontend`）
- 技术栈：React 18 + Ant Design 5 + React Router 6 + Axios + Vite；复用药房系统的列表/表单/模态框交互模式。
- 患者端：
  - `DoctorListPage`：展示可预约医生（表格/卡片），点击进入排班。
  - `DoctorSchedulePage`：按日期展示时间段与余量；支持筛选与预约弹窗确认。
  - `MyAppointmentsPage`：查看与取消预约。
- 医生端：
  - `MySchedulesPage`：发布/管理排班（Form + Table）。
  - `MyAppointmentsPage`：查看自己被预约的列表。
- 路由与权限：React Router 按角色控制访问，登录后根据`role/status`跳转；`pending`医生禁止进入医生端页面。
- Axios 封装：拦截器统一附加令牌，统一错误处理；接口路径与DTO对齐。

## DTO 与校验
- 后端 Pydantic：
  - `ScheduleCreate`, `ScheduleResponse`。
  - `AppointmentCreate`, `AppointmentResponse`。
- 前端请求/响应类型与表单校验同步；时间字段统一使用 ISO 字符串，后端落库为 `DATE` + `TIME` 或 `DATETIME`。

## 集成与改动点
- 修改：`medical-system/backend/main.py` 注册新路由模块；`CORS` 已存在可复用。
- 新增：`appointments/backend/routes.py`、`schemas.py` 扩展、`models.py` 扩展、`init_db.sql` 迁移片段。
- 新增前端：`frontend/package.json`、`src/pages/...`、`src/api/axios.ts`、`src/router/index.tsx`、`src/components/...`。

## 校验与测试
- 后端：
  - 单元测试：容量校验、重复预约、取消回滚、角色权限。
  - 假数据：创建2名`active`医生与若干排班，患者预约流程贯通。
- 前端：
  - 手工流测试：登录→医生列表→查看排班→预约→我的预约→取消。
  - 空态与错误提示（无排班、容量不足、权限不足）。

## 安全与合规
- 仅展示`active`医生；`pending`医生不可见且不可预约。
- 患者仅能操作自己的预约；医生仅能管理自己的排班与预约。
- 管理员具备审计与兜底取消权限。

## 兼容性与演进
- 若未来增加科室/专科、时间粒度更细、支付/短信提醒，可在`DoctorSchedule`扩展字段或增加`ScheduleSlot`子表。
- 不改动现有登录与角色架构，避免破坏现有模块。

## 交付物
- 后端：模型与路由实现、SQL迁移、测试用例。
- 前端：页面与组件、路由、Axios 封装、接口联调。

—— 请确认方案；确认后我将落地实现、联调并提交可运行的代码与测试。